#!/bin/bash

# Git Flow Commit Message Validator
# Enforces Conventional Commits format

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Skip merge commits
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Conventional Commits regex
REGEX='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,50}'

if ! echo "$COMMIT_MSG" | grep -qE "$REGEX"; then
    echo -e "${RED}‚ùå ERROR: Commit message doesn't follow Conventional Commits format!${NC}"
    echo ""
    echo -e "${YELLOW}üìù Conventional Commits Format:${NC}"
    echo "   <type>(<scope>): <subject>"
    echo ""
    echo -e "${GREEN}Valid types:${NC}"
    echo "   feat     - New feature"
    echo "   fix      - Bug fix"
    echo "   docs     - Documentation changes"
    echo "   style    - Code style changes (formatting, etc)"
    echo "   refactor - Code refactoring"
    echo "   test     - Adding or updating tests"
    echo "   chore    - Maintenance tasks"
    echo "   perf     - Performance improvements"
    echo "   ci       - CI/CD changes"
    echo "   build    - Build system changes"
    echo "   revert   - Reverting previous commit"
    echo ""
    echo -e "${GREEN}Examples:${NC}"
    echo "   feat(auth): add login functionality"
    echo "   fix(api): resolve null pointer exception"
    echo "   docs: update README with new examples"
    echo "   chore: bump version to 1.2.0"
    echo ""
    echo -e "${YELLOW}Your message:${NC} $COMMIT_MSG"
    echo ""
    exit 1
fi

# Check commit message length
SUBJECT_LENGTH=$(echo "$COMMIT_MSG" | head -1 | wc -c)
if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Commit subject is $SUBJECT_LENGTH characters (recommended: <72)${NC}"
fi

# Check for BREAKING CHANGE in body
if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE"; then
    echo -e "${YELLOW}‚ö†Ô∏è  BREAKING CHANGE detected - ensure this is intentional${NC}"
    echo "   This will trigger a major version bump in the next release"
fi

exit 0